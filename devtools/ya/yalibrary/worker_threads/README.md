# Worker Threads

`WorkerThreads` является исполнителем различных тасок, помещенных в очередь для исполнения [`RunQueue`](https://a.yandex-team.ru/arcadia/devtools/ya/yalibrary/runner/runqueue.py). `WorkerThreads` инициализируется словарем <тип пула воркеров>: <количество создаваемых тредов>, размером потребленных на текущий момент ресурсов (по умолчанию `ResInfo()`, то есть никакие ресурсы изначально не используются), верхним порогом потребляемых ресурсов, выход за который не допускается и, опционально, event логом.

При инициализации в `WorkerThreads` создаются потоки, каждый из которых выполняет функцию `exec_target`. В `exec_target` поток старается взять из очереди на исполнение таску с наибольшим приоритетом среди тех, которые могут быть исполнены с учетом свободных ресурсов. Очередь - это словарь списков, где ключ - экземпляр класса `ResInfo`, значение - список, поддерживаемый как priority queue с помощью `heapq`
С целью более компактного отображения событий event лога в браузерном трейсере (см. [`ya analyze-make`](https://docs.yandex-team.ru/ya-make/usage/ya_analyze/timeline)) потоки были разделены на пулы ([YA-852](https://st.yandex-team.ru/YA-852)).

Добавление тасок в очередь происходит через метод `add`. Таску можно исполнить в обход очереди, передав соответствующий флаг.

Исполнение тасок происходит в методе `__execute_action`. Результат выполнения складывается в очередь результатов `Queue`.

`WorkerThreads` реализует протокол итератора. Извлечение результатов происходит в методе `next`, в который извне опционально передается коллбек функция `ready_to_stop`, сигнализирующая об окончании работы. Если коллбек не передан, выполнение заканчивается как только количество активных задач (находящихся в очереди результатов) равно 0. В обоих случаях выбрасывается исключение `StopIteration`.
